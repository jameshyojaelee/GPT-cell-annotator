[tox]
minversion = 4.11
envlist = py{39,310,311,312}-{lts,latest}, packaging

[testenv]
description = Run pytest, ruff, and mypy across Python/Scanpy compatibility tiers.
package = wheel
wheel_build_env = .pkg
extras =
    scanpy
    dev
setenv =
    PYTEST_DISABLE_PLUGIN_AUTOLOAD = 1
deps =
    lts: anndata>=0.9,<0.10
    lts: scanpy>=1.9,<1.10
    latest: anndata>=0.10
    latest: scanpy>=1.11
commands =
    pytest
    ruff check src scripts tests
    mypy src/backend src/gpt_cell_annotator src/config

[testenv:packaging]
description = Build distribution artifacts and run Scanpy smoke checks.
skip_install = true
deps =
    twine>=6.0.0
    uv>=0.4.0
commands =
    uv build
    twine check dist/*
    python - <<'PY'
import os
import pathlib
import shutil
import subprocess
import sys
import tempfile
import venv

dist_dir = pathlib.Path("dist")
wheels = sorted(dist_dir.glob("gpt_cell_annotator-*.whl"))
if not wheels:
    raise SystemExit("No wheel artifacts found in dist/")
wheel = wheels[-1]

tmp_dir = pathlib.Path(tempfile.mkdtemp(prefix="gca-packaging-"))
venv.create(tmp_dir, with_pip=True)
bin_dir = tmp_dir / ("Scripts" if os.name == "nt" else "bin")
pip = bin_dir / "pip"
gca = bin_dir / "gca"

subprocess.check_call([str(pip), "install", f"{wheel}[scanpy]"])
subprocess.check_call([str(gca), "--version"])
subprocess.check_call([str(gca), "scanpy", "--help"])

shutil.rmtree(tmp_dir, ignore_errors=True)
PY
